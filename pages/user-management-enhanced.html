<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Catalyst HR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="shortcut icon" href="../img/image.png" type="image/x-icon">
</head>
<body class="hr-page">
    <!-- Navigation will be inserted by role management -->

    <main class="py-5 mt-4">
        <div class="container-fluid">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-users-cog me-2"></i>
                        User Management
                    </h2>
                    <p class="text-muted mb-0">Manage system users and their profiles</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-success" id="import-users">
                        <i class="fas fa-upload me-1"></i>Import
                    </button>
                    <button class="btn btn-outline-info" id="export-users">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal">
                        <i class="fas fa-user-plus me-1"></i>New User
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="fs-3 fw-bold text-primary" id="total-users">0</div>
                            <div class="text-muted">Total Users</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="fs-3 fw-bold text-success" id="active-users">0</div>
                            <div class="text-muted">Active</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="fs-3 fw-bold text-info" id="admin-users">0</div>
                            <div class="text-muted">Administrators</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="fs-3 fw-bold text-warning" id="pending-users">0</div>
                            <div class="text-muted">Pending</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Search Users</label>
                            <input type="text" class="form-control" id="search-users" placeholder="Name, email, department...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="filter-role">
                                <option value="">All</option>
                                <option value="admin">Administrator</option>
                                <option value="recruiter">Recruiter</option>
                                <option value="hiring_manager">Hiring Manager</option>
                                <option value="candidate">Candidate</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="filter-status">
                                <option value="">All</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="pending">Pending</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Department</label>
                            <select class="form-select" id="filter-department">
                                <option value="">All</option>
                                <option value="Human Resources">HR</option>
                                <option value="Technology">Technology</option>
                                <option value="Design">Design</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Operations">Operations</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-outline-secondary w-100" id="clear-filters">
                                <i class="fas fa-times me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">User List</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>User</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Department</th>
                                    <th>Location</th>
                                    <th>Status</th>
                                    <th>Registration Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- Content will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalTitle">New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="user-form">
                        <div class="row">
                            <!-- Profile Information -->
                            <div class="col-md-8">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">Personal Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Full Name *</label>
                                                <input type="text" class="form-control" id="user-name" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Email *</label>
                                                <input type="email" class="form-control" id="user-email" required>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Phone</label>
                                                <input type="tel" class="form-control" id="user-phone" placeholder="+1 234 567 8901">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Position</label>
                                                <input type="text" class="form-control" id="user-position" placeholder="Job title or position">
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Location</label>
                                                <input type="text" class="form-control" id="user-location" placeholder="City, Country">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Department</label>
                                                <select class="form-select" id="user-department">
                                                    <option value="Human Resources">Human Resources</option>
                                                    <option value="Technology">Technology</option>
                                                    <option value="Design">Design</option>
                                                    <option value="Marketing">Marketing</option>
                                                    <option value="Sales">Sales</option>
                                                    <option value="Operations">Operations</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Join Date</label>
                                                <input type="date" class="form-control" id="user-join-date">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Professional Profile -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">Professional Profile</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Professional Biography</label>
                                            <textarea class="form-control" rows="3" id="user-bio" placeholder="Brief description of the professional profile..."></textarea>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Skills</label>
                                                <input type="text" class="form-control" id="user-skills" placeholder="JavaScript, React, Management... (comma separated)">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Years of Experience</label>
                                                <select class="form-select" id="user-experience">
                                                    <option value="0-1">0-1 years</option>
                                                    <option value="2-3">2-3 years</option>
                                                    <option value="4-5">4-5 years</option>
                                                    <option value="6-10">6-10 years</option>
                                                    <option value="10+">More than 10 years</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">LinkedIn</label>
                                                <input type="url" class="form-control" id="user-linkedin" placeholder="https://linkedin.com/in/user">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">GitHub</label>
                                                <input type="url" class="form-control" id="user-github" placeholder="https://github.com/user">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Avatar and Access Control -->
                            <div class="col-md-4">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">Profile Picture</h6>
                                    </div>
                                    <div class="card-body text-center">
                                        <img id="user-avatar-preview" src="https://via.placeholder.com/150/6b7280/white?text=User" 
                                             class="rounded-circle mb-3" style="width: 120px; height: 120px; object-fit: cover;">
                                        <input type="file" class="form-control" id="user-avatar" accept="image/*">
                                        <small class="text-muted">JPG, PNG (max. 1MB)</small>
                                    </div>
                                </div>

                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">Access Control</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">System Role *</label>
                                            <select class="form-select" id="user-role" required>
                                                <option value="candidate">Candidate</option>
                                                <option value="recruiter">Recruiter</option>
                                                <option value="hiring_manager">Hiring Manager</option>
                                                <option value="admin">Administrator</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Status</label>
                                            <select class="form-select" id="user-status">
                                                <option value="active">Active</option>
                                                <option value="inactive">Inactive</option>
                                                <option value="pending">Pending</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Permissions</label>
                                            <div id="permissions-container">
                                                <!-- Permissions will be populated based on role -->
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Account Settings</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="user-email-notifications" checked>
                                            <label class="form-check-label" for="user-email-notifications">
                                                Email Notifications
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="user-sms-notifications">
                                            <label class="form-check-label" for="user-sms-notifications">
                                                SMS Notifications
                                            </label>
                                        </div>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="checkbox" id="user-two-factor">
                                            <label class="form-check-label" for="user-two-factor">
                                                Two-Factor Authentication
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-user">
                        <i class="fas fa-save me-1"></i>Save User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div class="modal fade" id="userProfileModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="profileModalTitle">User Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="profile-modal-body">
                    <!-- Profile content will be populated by JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-info" id="send-welcome-email">
                        <i class="fas fa-envelope me-1"></i>Send Welcome Email
                    </button>
                    <button type="button" class="btn btn-primary" id="edit-profile">
                        <i class="fas fa-edit me-1"></i>Edit Profile
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="hidden-file-input" style="display: none;" accept=".json,.csv">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initNavigation } from '../js/navigation.js';
        import { initializeGuards } from '../js/guards.js';
        import { dataManager, exportImportManager } from '../js/data-manager.js';

        let currentUsers = [];
        let editingUserId = null;

        const rolePermissions = {
            candidate: ['profile', 'applications', 'courses'],
            recruiter: ['jobs', 'candidates', 'interviews', 'reports'],
            hiring_manager: ['interviews', 'evaluations', 'pipeline', 'reports'],
            admin: ['all']
        };

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize navigation and guards
            initNavigation('user-management', true);
            initializeGuards('user-management-enhanced.html');

            // Load and display users
            loadUsers();
            updateStats();

            // Event listeners
            document.getElementById('search-users').addEventListener('input', filterUsers);
            document.getElementById('filter-role').addEventListener('change', filterUsers);
            document.getElementById('filter-status').addEventListener('change', filterUsers);
            document.getElementById('filter-department').addEventListener('change', filterUsers);
            document.getElementById('clear-filters').addEventListener('click', clearFilters);

            // Modal events
            document.getElementById('save-user').addEventListener('click', saveUser);
            document.getElementById('export-users').addEventListener('click', exportUsers);
            document.getElementById('import-users').addEventListener('click', () => {
                document.getElementById('hidden-file-input').click();
            });

            // File import
            document.getElementById('hidden-file-input').addEventListener('change', handleFileImport);

            // Avatar preview
            document.getElementById('user-avatar').addEventListener('change', handleAvatarPreview);

            // Role change handler
            document.getElementById('user-role').addEventListener('change', updatePermissions);

            // Reset modal when closed
            document.getElementById('userModal').addEventListener('hidden.bs.modal', resetModal);

            // Set default join date
            document.getElementById('user-join-date').value = new Date().toISOString().split('T')[0];
        });

        function loadUsers() {
            currentUsers = dataManager.getUsers();
            renderUsersTable(currentUsers);
        }

        function renderUsersTable(users) {
            const tableBody = document.getElementById('users-table-body');
            
            if (users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-users fa-2x mb-2"></i><br>
                            No users found
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = users.map(user => `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="${user.avatar || 'https://via.placeholder.com/40/6b7280/white?text=' + user.name.substring(0,2)}" 
                                 class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
                            <div>
                                <div class="fw-bold">${user.name}</div>
                                <div class="small text-muted">${user.position || 'No position assigned'}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div>${user.email}</div>
                        <div class="small text-muted">${user.phone || 'No phone'}</div>
                    </td>
                    <td>
                        <span class="badge bg-${getRoleColor(user.role)}">${getRoleLabel(user.role)}</span>
                    </td>
                    <td>${user.department || 'N/A'}</td>
                    <td>
                        <i class="fas fa-map-marker-alt text-muted me-1"></i>
                        ${user.location || 'Not specified'}
                    </td>
                    <td>
                        <span class="badge bg-${getStatusColor(user.status)}">${getStatusLabel(user.status)}</span>
                    </td>
                    <td>
                        <div class="small">
                            ${user.joinDate ? new Date(user.joinDate).toLocaleDateString('en-US') : 'N/A'}
                        </div>
                    </td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewUserProfile(${user.id})" title="View profile">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="editUser(${user.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="resetPassword(${user.id})" title="Reset password">
                                <i class="fas fa-key"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterUsers() {
            const searchTerm = document.getElementById('search-users').value.toLowerCase();
            const roleFilter = document.getElementById('filter-role').value;
            const statusFilter = document.getElementById('filter-status').value;
            const departmentFilter = document.getElementById('filter-department').value;

            const filteredUsers = currentUsers.filter(user => {
                const matchesSearch = !searchTerm || 
                    user.name.toLowerCase().includes(searchTerm) ||
                    user.email.toLowerCase().includes(searchTerm) ||
                    (user.department && user.department.toLowerCase().includes(searchTerm));

                const matchesRole = !roleFilter || user.role === roleFilter;
                const matchesStatus = !statusFilter || user.status === statusFilter;
                const matchesDepartment = !departmentFilter || user.department === departmentFilter;

                return matchesSearch && matchesRole && matchesStatus && matchesDepartment;
            });

            renderUsersTable(filteredUsers);
        }

        function clearFilters() {
            document.getElementById('search-users').value = '';
            document.getElementById('filter-role').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-department').value = '';
            renderUsersTable(currentUsers);
        }

        function updateStats() {
            const users = dataManager.getUsers();
            
            const totalUsers = users.length;
            const activeUsers = users.filter(user => user.status === 'active').length;
            const adminUsers = users.filter(user => user.role === 'admin').length;
            const pendingUsers = users.filter(user => user.status === 'pending').length;

            document.getElementById('total-users').textContent = totalUsers;
            document.getElementById('active-users').textContent = activeUsers;
            document.getElementById('admin-users').textContent = adminUsers;
            document.getElementById('pending-users').textContent = pendingUsers;
        }

        function updatePermissions() {
            const role = document.getElementById('user-role').value;
            const container = document.getElementById('permissions-container');
            const permissions = rolePermissions[role] || [];

            if (role === 'admin') {
                container.innerHTML = `
                    <div class="alert alert-info small">
                        <i class="fas fa-crown me-2"></i>
                        Administrators have full access to the system.
                    </div>
                `;
            } else {
                container.innerHTML = permissions.map(permission => `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" checked disabled>
                        <label class="form-check-label small">${getPermissionLabel(permission)}</label>
                    </div>
                `).join('');
            }
        }

        function saveUser() {
            const form = document.getElementById('user-form');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const userData = {
                name: document.getElementById('user-name').value,
                email: document.getElementById('user-email').value,
                phone: document.getElementById('user-phone').value,
                position: document.getElementById('user-position').value,
                location: document.getElementById('user-location').value,
                department: document.getElementById('user-department').value,
                joinDate: document.getElementById('user-join-date').value,
                bio: document.getElementById('user-bio').value,
                skills: document.getElementById('user-skills').value.split(',').map(s => s.trim()).filter(s => s),
                experience: document.getElementById('user-experience').value,
                linkedin: document.getElementById('user-linkedin').value,
                github: document.getElementById('user-github').value,
                role: document.getElementById('user-role').value,
                status: document.getElementById('user-status').value,
                avatar: document.getElementById('user-avatar-preview').src,
                permissions: rolePermissions[document.getElementById('user-role').value] || [],
                emailNotifications: document.getElementById('user-email-notifications').checked,
                smsNotifications: document.getElementById('user-sms-notifications').checked,
                twoFactor: document.getElementById('user-two-factor').checked
            };

            const users = dataManager.getUsers();

            if (editingUserId) {
                // Update existing user
                const index = users.findIndex(user => user.id === editingUserId);
                if (index !== -1) {
                    users[index] = { ...users[index], ...userData };
                    dataManager.setUsers(users);
                    showToast('User updated successfully', 'success');
                }
            } else {
                // Check if email already exists
                if (users.some(user => user.email === userData.email)) {
                    showToast('A user with this email already exists', 'error');
                    return;
                }

                // Create new user
                const newUser = {
                    id: dataManager.generateId('users'),
                    ...userData,
                    createdAt: new Date().toISOString()
                };
                users.push(newUser);
                dataManager.setUsers(users);
                showToast('User created successfully', 'success');
            }

            // Close modal and refresh
            const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
            modal.hide();
            loadUsers();
            updateStats();
        }

        function editUser(userId) {
            const user = dataManager.findById('users', userId);
            if (!user) return;

            editingUserId = userId;
            
            // Fill form with user data
            document.getElementById('user-name').value = user.name || '';
            document.getElementById('user-email').value = user.email || '';
            document.getElementById('user-phone').value = user.phone || '';
            document.getElementById('user-position').value = user.position || '';
            document.getElementById('user-location').value = user.location || '';
            document.getElementById('user-department').value = user.department || 'Human Resources';
            document.getElementById('user-join-date').value = user.joinDate || '';
            document.getElementById('user-bio').value = user.bio || '';
            document.getElementById('user-skills').value = (user.skills || []).join(', ');
            document.getElementById('user-experience').value = user.experience || '0-1';
            document.getElementById('user-linkedin').value = user.linkedin || '';
            document.getElementById('user-github').value = user.github || '';
            document.getElementById('user-role').value = user.role || 'candidate';
            document.getElementById('user-status').value = user.status || 'active';
            
            // Checkboxes
            document.getElementById('user-email-notifications').checked = user.emailNotifications !== false;
            document.getElementById('user-sms-notifications').checked = user.smsNotifications || false;
            document.getElementById('user-two-factor').checked = user.twoFactor || false;
            
            if (user.avatar) {
                document.getElementById('user-avatar-preview').src = user.avatar;
            }

            updatePermissions();
            document.getElementById('userModalTitle').textContent = 'Edit User';
            new bootstrap.Modal(document.getElementById('userModal')).show();
        }

        function viewUserProfile(userId) {
            const user = dataManager.findById('users', userId);
            if (!user) return;

            const profileBody = document.getElementById('profile-modal-body');
            const applications = dataManager.getApplications().filter(app => app.user_id === userId);
            
            profileBody.innerHTML = `
                <div class="row">
                    <div class="col-md-4 text-center">
                        <img src="${user.avatar || 'https://via.placeholder.com/150/6b7280/white?text=' + user.name.substring(0,2)}" 
                             class="rounded-circle mb-3" style="width: 120px; height: 120px; object-fit: cover;">
                        <h5>${user.name}</h5>
                        <p class="text-muted">${user.position || 'No position'}</p>
                        <span class="badge bg-${getRoleColor(user.role)} mb-2">${getRoleLabel(user.role)}</span>
                        <div class="badge bg-${getStatusColor(user.status)}">${getStatusLabel(user.status)}</div>
                    </div>
                    <div class="col-md-8">
                        <div class="row mb-3">
                            <div class="col-6">
                                <strong>Email:</strong><br>
                                <span class="text-muted">${user.email}</span>
                            </div>
                            <div class="col-6">
                                <strong>Phone:</strong><br>
                                <span class="text-muted">${user.phone || 'Not specified'}</span>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <strong>Department:</strong><br>
                                <span class="text-muted">${user.department || 'N/A'}</span>
                            </div>
                            <div class="col-6">
                                <strong>Location:</strong><br>
                                <span class="text-muted">${user.location || 'Not specified'}</span>
                            </div>
                        </div>
                        ${user.bio ? `
                        <div class="mb-3">
                            <strong>Biography:</strong><br>
                            <span class="text-muted">${user.bio}</span>
                        </div>
                        ` : ''}
                        ${user.skills && user.skills.length > 0 ? `
                        <div class="mb-3">
                            <strong>Skills:</strong><br>
                            ${user.skills.map(skill => `<span class="badge bg-light text-dark me-1">${skill}</span>`).join('')}
                        </div>
                        ` : ''}
                        <div class="row">
                            ${user.linkedin ? `
                            <div class="col-6">
                                <a href="${user.linkedin}" target="_blank" class="btn btn-outline-primary btn-sm">
                                    <i class="fab fa-linkedin me-1"></i>LinkedIn
                                </a>
                            </div>
                            ` : ''}
                            ${user.github ? `
                            <div class="col-6">
                                <a href="${user.github}" target="_blank" class="btn btn-outline-dark btn-sm">
                                    <i class="fab fa-github me-1"></i>GitHub
                                </a>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                ${applications.length > 0 ? `
                <hr>
                <h6>Recent Applications</h6>
                <div class="row">
                    ${applications.slice(0, 3).map(app => {
                        const job = dataManager.findById('jobs', app.job_id);
                        return `
                        <div class="col-md-4 mb-2">
                            <div class="border rounded p-2">
                                <div class="fw-bold small">${job ? job.title : 'Deleted vacancy'}</div>
                                <div class="text-muted small">${new Date(app.applied_date).toLocaleDateString('en-US')}</div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
                ` : ''}
            `;

            document.getElementById('edit-profile').onclick = () => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('userProfileModal'));
                modal.hide();
                editUser(userId);
            };

            new bootstrap.Modal(document.getElementById('userProfileModal')).show();
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                dataManager.deleteById('users', userId);
                loadUsers();
                updateStats();
                showToast('User deleted successfully', 'warning');
            }
        }

        function resetPassword(userId) {
            if (confirm('Do you want to reset this user\'s password?')) {
                const tempPassword = Math.random().toString(36).slice(-8);
                showToast(`Password reset. New temporary password: ${tempPassword}`, 'success');
            }
        }

        function resetModal() {
            editingUserId = null;
            document.getElementById('user-form').reset();
            document.getElementById('userModalTitle').textContent = 'New User';
            document.getElementById('user-avatar-preview').src = 'https://via.placeholder.com/150/6b7280/white?text=User';
            document.getElementById('user-join-date').value = new Date().toISOString().split('T')[0];
            updatePermissions();
        }

        function handleAvatarPreview(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 1024 * 1024) { // 1MB limit
                    showToast('Image is too large. Maximum 1MB.', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('user-avatar-preview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function exportUsers() {
            const users = dataManager.getUsers();
            const exportData = users.map(user => ({
                id: user.id,
                name: user.name,
                email: user.email,
                role: user.role,
                department: user.department,
                position: user.position,
                location: user.location,
                phone: user.phone,
                status: user.status,
                joinDate: user.joinDate
            }));

            exportImportManager.exportToCSV(exportData, 'catalyst_users.csv');
            showToast('Users exported successfully', 'success');
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type === 'application/json' || file.name.endsWith('.json')) {
                exportImportManager.importFromFile(file, (success, data, error) => {
                    if (success) {
                        loadUsers();
                        updateStats();
                        showToast('Users imported successfully', 'success');
                    } else {
                        showToast('Error importing file: ' + (error?.message || 'Invalid format'), 'error');
                    }
                });
            } else {
                showToast('File format not supported. Use JSON or CSV.', 'warning');
            }
        }

        function getRoleColor(role) {
            const colors = {
                'admin': 'danger',
                'recruiter': 'primary',
                'hiring_manager': 'info',
                'candidate': 'success'
            };
            return colors[role] || 'secondary';
        }

        function getRoleLabel(role) {
            const labels = {
                'admin': 'Administrator',
                'recruiter': 'Recruiter',
                'hiring_manager': 'Hiring Manager',
                'candidate': 'Candidate'
            };
            return labels[role] || role;
        }

        function getStatusColor(status) {
            const colors = {
                'active': 'success',
                'inactive': 'secondary',
                'pending': 'warning'
            };
            return colors[status] || 'secondary';
        }

        function getStatusLabel(status) {
            const labels = {
                'active': 'Active',
                'inactive': 'Inactive',
                'pending': 'Pending'
            };
            return labels[status] || status;
        }

        function getPermissionLabel(permission) {
            const labels = {
                'all': 'Full Access',
                'jobs': 'Job Management',
                'candidates': 'Candidate Management',
                'interviews': 'Interview Scheduling',
                'reports': 'Reports',
                'profile': 'Profile Management',
                'applications': 'Applications',
                'courses': 'Training',
                'evaluations': 'Evaluations',
                'pipeline': 'Hiring Pipeline'
            };
            return labels[permission] || permission;
        }

        function showToast(message, type = 'info') {
            const alertClass = type === 'error' ? 'danger' : type;
            const toast = document.createElement('div');
            toast.className = `alert alert-${alertClass} position-fixed top-0 end-0 m-3`;
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // Initialize permissions on page load
        updatePermissions();

        // Make functions globally available
        window.editUser = editUser;
        window.deleteUser = deleteUser;
        window.viewUserProfile = viewUserProfile;
        window.resetPassword = resetPassword;
    </script>
</body>
</html>