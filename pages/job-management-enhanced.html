<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Management - Catalyst HR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="shortcut icon" href="../img/image.png" type="image/x-icon">
</head>
<body class="hr-page">
    <!-- Navigation will be inserted by role management -->

    <main class="py-5 mt-4">
        <div class="container-fluid">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-briefcase me-2"></i>
                        Job Management
                    </h2>
                    <p class="text-muted mb-0">Manage job offers and active vacancies</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-success" id="import-jobs">
                        <i class="fas fa-upload me-1"></i>Import
                    </button>
                    <button class="btn btn-outline-info" id="export-jobs">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#jobModal">
                        <i class="fas fa-plus me-1"></i>New Vacancy
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="fs-3 fw-bold text-primary" id="total-jobs">0</div>
                            <div class="text-muted">Total Vacancies</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="fs-3 fw-bold text-success" id="active-jobs">0</div>
                            <div class="text-muted">Active</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="fs-3 fw-bold text-warning" id="total-applications">0</div>
                            <div class="text-muted">Total Applications</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="fs-3 fw-bold text-info" id="avg-applications">0</div>
                            <div class="text-muted">Average per Vacancy</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters and Search -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Search Vacancies</label>
                            <input type="text" class="form-control" id="search-jobs" placeholder="Title, company, location...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="filter-status">
                                <option value="">All</option>
                                <option value="active">Active</option>
                                <option value="paused">Paused</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Level</label>
                            <select class="form-select" id="filter-level">
                                <option value="">All</option>
                                <option value="Junior">Junior</option>
                                <option value="Mid-Level">Mid-Level</option>
                                <option value="Senior">Senior</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Type</label>
                            <select class="form-select" id="filter-type">
                                <option value="">All</option>
                                <option value="Full Time">Full Time</option>
                                <option value="Part Time">Part Time</option>
                                <option value="Contract">Contract</option>
                                <option value="Freelance">Freelance</option>
                            </select>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button class="btn btn-outline-secondary w-100" id="clear-filters">
                                <i class="fas fa-times me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Jobs Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Vacancies List</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Vacancy</th>
                                    <th>Company</th>
                                    <th>Location</th>
                                    <th>Type/Level</th>
                                    <th>Applications</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="jobs-table-body">
                                <!-- Content will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Job Modal -->
    <div class="modal fade" id="jobModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="jobModalTitle">New Vacancy</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="job-form">
                        <div class="row">
                            <div class="col-md-8">
                                <!-- Basic Information -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">Basic Information</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Vacancy Title *</label>
                                                <input type="text" class="form-control" id="job-title" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Company *</label>
                                                <input type="text" class="form-control" id="job-company" required>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Location *</label>
                                                <input type="text" class="form-control" id="job-location" required>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Job Type *</label>
                                                <select class="form-select" id="job-type" required>
                                                    <option value="Full Time">Full Time</option>
                                                    <option value="Part Time">Part Time</option>
                                                    <option value="Contract">Contract</option>
                                                    <option value="Freelance">Freelance</option>
                                                    <option value="Internship">Internship</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <label class="form-label">Level *</label>
                                                <select class="form-select" id="job-level" required>
                                                    <option value="Junior">Junior</option>
                                                    <option value="Mid-Level">Mid-Level</option>
                                                    <option value="Senior">Senior</option>
                                                    <option value="Lead">Lead</option>
                                                    <option value="Manager">Manager</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Salary Range</label>
                                                <input type="text" class="form-control" id="job-salary" placeholder="$3,000,000 - $5,000,000 COP">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Deadline</label>
                                                <input type="date" class="form-control" id="job-deadline">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Job Description *</label>
                                            <textarea class="form-control" rows="4" id="job-description" required placeholder="Describe the responsibilities and the ideal candidate profile..."></textarea>
                                        </div>
                                    </div>
                                </div>

                                <!-- Requirements and Benefits -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">Requirements and Benefits</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Requirements</label>
                                                <textarea class="form-control" rows="4" id="job-requirements" placeholder="• Minimum 3 years experience&#10;• Knowledge in X, Y, Z technologies&#10;• Specific certifications"></textarea>
                                                <small class="text-muted">Separate each requirement with a new line</small>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Benefits</label>
                                                <textarea class="form-control" rows="4" id="job-benefits" placeholder="• Competitive salary&#10;• Health insurance&#10;• Flexible remote work"></textarea>
                                                <small class="text-muted">Separate each benefit with a new line</small>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Required Skills</label>
                                            <input type="text" class="form-control" id="job-skills" placeholder="JavaScript, React, Node.js, SQL... (comma separated)">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <!-- Job Status and Configuration -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h6 class="mb-0">Status and Configuration</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">Vacancy Status</label>
                                            <select class="form-select" id="job-status">
                                                <option value="active">Active</option>
                                                <option value="paused">Paused</option>
                                                <option value="closed">Closed</option>
                                                <option value="draft">Draft</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Priority</label>
                                            <select class="form-select" id="job-priority">
                                                <option value="normal">Normal</option>
                                                <option value="high">High</option>
                                                <option value="urgent">Urgent</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Department</label>
                                            <select class="form-select" id="job-department">
                                                <option value="Technology">Technology</option>
                                                <option value="Design">Design</option>
                                                <option value="Marketing">Marketing</option>
                                                <option value="Sales">Sales</option>
                                                <option value="HR">Human Resources</option>
                                                <option value="Operations">Operations</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="job-remote">
                                                <label class="form-check-label" for="job-remote">
                                                    Remote Work Available
                                                </label>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="job-featured">
                                                <label class="form-check-label" for="job-featured">
                                                    Featured Vacancy
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Image Upload -->
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Job Image</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="text-center mb-3">
                                            <img id="job-image-preview" src="https://via.placeholder.com/300x200/f8fafc/666666?text=No+Image" 
                                                 class="img-fluid rounded" style="max-height: 150px;">
                                        </div>
                                        <input type="file" class="form-control" id="job-image" accept="image/*">
                                        <small class="text-muted">Formats: JPG, PNG (max. 2MB)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-job">
                        <i class="fas fa-save me-1"></i>Save Vacancy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import Vacancies</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select File</label>
                        <input type="file" class="form-control" id="import-file" accept=".json,.csv">
                        <small class="text-muted">Supported formats: JSON, CSV</small>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        The file must contain the columns: title, company, location, type, level, description, requirements, benefits.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirm-import">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="hidden-file-input" style="display: none;" accept=".json,.csv">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initNavigation } from '../js/modules/navigation.js';
        import { updateAuthUI } from '../js/modules/auth.js';
        import { initializeGuards, getCurrentUser, ROLES } from '../js/guards.js';
        import { dataManager, exportImportManager } from '../js/data-manager.js';

        let currentJobs = [];
        let editingJobId = null;

        document.addEventListener('DOMContentLoaded', () => {
            // Check authentication and permissions first using auth module
            import('../js/modules/auth.js').then(({ getCurrentUser, hasAnyRole, ROLES }) => {
                const user = getCurrentUser();
                const allowedRoles = [ROLES.ADMIN, ROLES.HR_MANAGER, ROLES.HIRING_MANAGER];
                
                if (!user) {
                    // Not authenticated - redirect to login
                    const returnUrl = encodeURIComponent(window.location.href);
                    window.location.href = `login.html?returnUrl=${returnUrl}`;
                    return;
                }
                
                if (!hasAnyRole(allowedRoles)) {
                    // User doesn't have required role
                    document.body.innerHTML = `
                        <div class="container mt-5 pt-5">
                            <div class="row justify-content-center">
                                <div class="col-md-8 col-lg-6">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body text-center py-5">
                                            <div class="mb-4">
                                                <i class="fas fa-shield-alt text-warning" style="font-size: 4rem;"></i>
                                            </div>
                                            <h3 class="text-danger mb-3">Access Denied</h3>
                                            <p class="text-muted mb-4">You do not have permissions to access job management.<br>
                                            Required role: <strong>Administrator</strong>, <strong>Human Resources</strong> or <strong>Hiring Manager</strong>.<br>
                                            Your current role: <span class="badge bg-secondary">${user.role}</span></p>
                                            <div class="d-flex gap-3 justify-content-center">
                                                <button onclick="history.back()" class="btn btn-outline-secondary">
                                                    <i class="fas fa-arrow-left me-2"></i> Back
                                                </button>
                                                <a href="../index.html" class="btn btn-primary">
                                                    <i class="fas fa-home me-2"></i> Go to Home
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // User has access - initialize page
                initializePage();
                
            }).catch(error => {
                console.error('Error checking authentication:', error);
                // Fallback: redirect to login
                const returnUrl = encodeURIComponent(window.location.href);
                window.location.href = `login.html?returnUrl=${returnUrl}`;
            });
        });
        
        function initializePage() {
            // Initialize navigation and auth UI
            initNavigation('job-management-enhanced', true);
            updateAuthUI();
            
            // Initialize guards for additional security
            initializeGuards('job-management-enhanced.html');

            // Load and display jobs
            loadJobs();
            updateStats();

            // Event listeners
            document.getElementById('search-jobs').addEventListener('input', filterJobs);
            document.getElementById('filter-status').addEventListener('change', filterJobs);
            document.getElementById('filter-level').addEventListener('change', filterJobs);
            document.getElementById('filter-type').addEventListener('change', filterJobs);
            document.getElementById('clear-filters').addEventListener('click', clearFilters);

            // Modal events
            document.getElementById('save-job').addEventListener('click', saveJob);
            document.getElementById('export-jobs').addEventListener('click', exportJobs);
            document.getElementById('import-jobs').addEventListener('click', () => {
                document.getElementById('hidden-file-input').click();
            });

            // File import
            document.getElementById('hidden-file-input').addEventListener('change', handleFileImport);

            // Image preview
            document.getElementById('job-image').addEventListener('change', handleImagePreview);

            // Reset modal when closed
            document.getElementById('jobModal').addEventListener('hidden.bs.modal', resetModal);
        }

        function loadJobs() {
            currentJobs = dataManager.getJobs();
            renderJobsTable(currentJobs);
        }

        function renderJobsTable(jobs) {
            const tableBody = document.getElementById('jobs-table-body');
            
            if (jobs.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="fas fa-briefcase fa-2x mb-2"></i><br>
                            No vacancies found
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = jobs.map(job => `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="${job.image || 'https://via.placeholder.com/50x50/f8fafc/666666?text=Job'}" 
                                 class="rounded me-2" style="width: 40px; height: 40px; object-fit: cover;">
                            <div>
                                <div class="fw-bold">${job.title}</div>
                                <div class="small text-muted">${job.salary || 'Salary not specified'}</div>
                            </div>
                        </div>
                    </td>
                    <td>${job.company}</td>
                    <td>
                        <i class="fas fa-map-marker-alt text-muted me-1"></i>
                        ${job.location}
                    </td>
                    <td>
                        <div class="small">
                            <div class="badge bg-primary">${job.type}</div>
                            <div class="badge bg-secondary mt-1">${job.level}</div>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-info fs-6">${job.applications || 0}</span>
                    </td>
                    <td>
                        <span class="badge bg-${getStatusColor(job.status)}">${getStatusLabel(job.status)}</span>
                    </td>
                    <td>
                        <div class="small">
                            <div>Posted: ${new Date(job.posted).toLocaleDateString('en-US')}</div>
                            ${job.deadline ? `<div class="text-muted">Closes: ${new Date(job.deadline).toLocaleDateString('en-US')}</div>` : ''}
                        </div>
                    </td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewJob(${job.id})" title="View details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="editJob(${job.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="viewApplications(${job.id})" title="View applications">
                                <i class="fas fa-users"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteJob(${job.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterJobs() {
            const searchTerm = document.getElementById('search-jobs').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const levelFilter = document.getElementById('filter-level').value;
            const typeFilter = document.getElementById('filter-type').value;

            const filteredJobs = currentJobs.filter(job => {
                const matchesSearch = !searchTerm || 
                    job.title.toLowerCase().includes(searchTerm) ||
                    job.company.toLowerCase().includes(searchTerm) ||
                    job.location.toLowerCase().includes(searchTerm);

                const matchesStatus = !statusFilter || job.status === statusFilter;
                const matchesLevel = !levelFilter || job.level === levelFilter;
                const matchesType = !typeFilter || job.type === typeFilter;

                return matchesSearch && matchesStatus && matchesLevel && matchesType;
            });

            renderJobsTable(filteredJobs);
        }

        function clearFilters() {
            document.getElementById('search-jobs').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-level').value = '';
            document.getElementById('filter-type').value = '';
            renderJobsTable(currentJobs);
        }

        function updateStats() {
            const jobs = dataManager.getJobs();
            const applications = dataManager.getApplications();
            
            const totalJobs = jobs.length;
            const activeJobs = jobs.filter(job => job.status === 'active').length;
            const totalApplications = applications.length;
            const avgApplications = totalJobs > 0 ? Math.round(totalApplications / totalJobs) : 0;

            document.getElementById('total-jobs').textContent = totalJobs;
            document.getElementById('active-jobs').textContent = activeJobs;
            document.getElementById('total-applications').textContent = totalApplications;
            document.getElementById('avg-applications').textContent = avgApplications;
        }

        function saveJob() {
            const form = document.getElementById('job-form');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const jobData = {
                title: document.getElementById('job-title').value,
                company: document.getElementById('job-company').value,
                location: document.getElementById('job-location').value,
                type: document.getElementById('job-type').value,
                level: document.getElementById('job-level').value,
                salary: document.getElementById('job-salary').value,
                description: document.getElementById('job-description').value,
                requirements: document.getElementById('job-requirements').value.split('\n').filter(r => r.trim()),
                benefits: document.getElementById('job-benefits').value.split('\n').filter(b => b.trim()),
                skills: document.getElementById('job-skills').value.split(',').map(s => s.trim()).filter(s => s),
                deadline: document.getElementById('job-deadline').value,
                status: document.getElementById('job-status').value,
                priority: document.getElementById('job-priority').value,
                department: document.getElementById('job-department').value,
                image: document.getElementById('job-image-preview').src
            };

            const jobs = dataManager.getJobs();

            if (editingJobId) {
                // Update existing job
                const index = jobs.findIndex(job => job.id === editingJobId);
                if (index !== -1) {
                    jobs[index] = { ...jobs[index], ...jobData };
                    dataManager.setJobs(jobs);
                    showToast('Vacancy updated successfully', 'success');
                }
            } else {
                // Create new job
                const newJob = {
                    id: dataManager.generateId('jobs'),
                    ...jobData,
                    posted: new Date().toISOString().split('T')[0],
                    applications: 0
                };
                jobs.push(newJob);
                dataManager.setJobs(jobs);
                showToast('Vacancy created successfully', 'success');
            }

            // Close modal and refresh
            const modal = bootstrap.Modal.getInstance(document.getElementById('jobModal'));
            modal.hide();
            loadJobs();
            updateStats();
        }

        function editJob(jobId) {
            const job = dataManager.findById('jobs', jobId);
            if (!job) return;

            editingJobId = jobId;
            
            // Fill form with job data
            document.getElementById('job-title').value = job.title || '';
            document.getElementById('job-company').value = job.company || '';
            document.getElementById('job-location').value = job.location || '';
            document.getElementById('job-type').value = job.type || '';
            document.getElementById('job-level').value = job.level || '';
            document.getElementById('job-salary').value = job.salary || '';
            document.getElementById('job-description').value = job.description || '';
            document.getElementById('job-requirements').value = (job.requirements || []).join('\n');
            document.getElementById('job-benefits').value = (job.benefits || []).join('\n');
            document.getElementById('job-skills').value = (job.skills || []).join(', ');
            document.getElementById('job-deadline').value = job.deadline || '';
            document.getElementById('job-status').value = job.status || 'active';
            document.getElementById('job-priority').value = job.priority || 'normal';
            document.getElementById('job-department').value = job.department || 'Technology';
            
            if (job.image) {
                document.getElementById('job-image-preview').src = job.image;
            }

            document.getElementById('jobModalTitle').textContent = 'Edit Vacancy';
            new bootstrap.Modal(document.getElementById('jobModal')).show();
        }

        function deleteJob(jobId) {
            if (confirm('Are you sure you want to delete this vacancy? This action cannot be undone.')) {
                dataManager.deleteById('jobs', jobId);
                loadJobs();
                updateStats();
                showToast('Vacancy deleted successfully', 'warning');
            }
        }

        function viewJob(jobId) {
            window.location.href = `job-detail.html?id=${jobId}`;
        }

        function viewApplications(jobId) {
            window.location.href = `resume-database.html?job=${jobId}`;
        }

        function resetModal() {
            editingJobId = null;
            document.getElementById('job-form').reset();
            document.getElementById('jobModalTitle').textContent = 'New Vacancy';
            document.getElementById('job-image-preview').src = 'https://via.placeholder.com/300x200/f8fafc/666666?text=No+Image';
        }

        function handleImagePreview(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('job-image-preview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function exportJobs() {
            const jobs = dataManager.getJobs();
            const exportData = jobs.map(job => ({
                id: job.id,
                title: job.title,
                company: job.company,
                location: job.location,
                type: job.type,
                level: job.level,
                salary: job.salary,
                description: job.description,
                status: job.status,
                applications: job.applications,
                posted: job.posted,
                deadline: job.deadline
            }));

            exportImportManager.exportToCSV(exportData, 'catalyst_vacancies.csv');
            showToast('Vacancies exported successfully', 'success');
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.type === 'application/json' || file.name.endsWith('.json')) {
                exportImportManager.importFromFile(file, (success, data, error) => {
                    if (success) {
                        loadJobs();
                        updateStats();
                        showToast('Data imported successfully', 'success');
                    } else {
                        showToast('Error importing file: ' + (error?.message || 'Invalid format'), 'error');
                    }
                });
            } else {
                showToast('File format not supported. Use JSON or CSV.', 'warning');
            }
        }

        function getStatusColor(status) {
            const colors = {
                'active': 'success',
                'paused': 'warning',
                'closed': 'secondary',
                'draft': 'info'
            };
            return colors[status] || 'secondary';
        }

        function getStatusLabel(status) {
            const labels = {
                'active': 'Active',
                'paused': 'Paused', 
                'closed': 'Closed',
                'draft': 'Draft'
            };
            return labels[status] || status;
        }

        function showToast(message, type = 'info') {
            const alertClass = type === 'error' ? 'danger' : type;
            const toast = document.createElement('div');
            toast.className = `alert alert-${alertClass} position-fixed top-0 end-0 m-3`;
            toast.style.zIndex = '9999';
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                ${message}
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        // Make functions globally available
        window.editJob = editJob;
        window.deleteJob = deleteJob;
        window.viewJob = viewJob;
        window.viewApplications = viewApplications;
    </script>
</body>
</html>