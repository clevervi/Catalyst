<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Certificates - Catalyst</title>
    <meta name="description" content="Manage and download your certificates for completed courses in Catalyst HR System">
    
    <!-- CSS Framework and Styles -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="shortcut icon" href="../img/image.png" type="image/x-icon">
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <!-- Navigation will be loaded dynamically -->
    
    <main class="py-5" style="padding-top: 100px;">
        <div class="container">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h1 class="h3 mb-2">
                                <i class="fas fa-certificate text-primary me-2"></i>
                                My Certificates
                            </h1>
                            <p class="text-muted mb-0">Manage and download your certificates for completed courses</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" id="filterCertificatesBtn">
                                <i class="fas fa-filter me-1"></i> Filter
                            </button>
                            <button class="btn btn-accent" id="downloadAllBtn">
                                <i class="fas fa-download me-1"></i> Download All
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="row mb-4" id="filtersRow" style="display: none;">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <label for="statusFilter" class="form-label">Status</label>
                                    <select class="form-select" id="statusFilter">
                                        <option value="">All</option>
                                        <option value="completed">Completed</option>
                                        <option value="expired">Expired</option>
                                        <option value="pending">Pending</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="categoryFilter" class="form-label">Category</label>
                                    <select class="form-select" id="categoryFilter">
                                        <option value="">All</option>
                                        <option value="frontend">Frontend</option>
                                        <option value="backend">Backend</option>
                                        <option value="data-science">Data Science</option>
                                        <option value="management">Management</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="dateFromFilter" class="form-label">From</label>
                                    <input type="date" class="form-control" id="dateFromFilter">
                                </div>
                                <div class="col-md-3">
                                    <label for="dateToFilter" class="form-label">To</label>
                                    <input type="date" class="form-control" id="dateToFilter">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="text-primary mb-2">
                                <i class="fas fa-certificate fa-2x"></i>
                            </div>
                            <h3 class="text-primary mb-1" id="totalCertificates">8</h3>
                            <small class="text-muted">Total Certificates</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="text-success mb-2">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                            <h3 class="text-success mb-1" id="validCertificates">6</h3>
                            <small class="text-muted">Valid</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="text-warning mb-2">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                            <h3 class="text-warning mb-1" id="expiringCertificates">1</h3>
                            <small class="text-muted">Expiring Soon</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <div class="text-info mb-2">
                                <i class="fas fa-trophy fa-2x"></i>
                            </div>
                            <h3 class="text-info mb-1" id="achievementScore">94</h3>
                            <small class="text-muted">Achievement Score</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Certificates Grid -->
            <div class="row" id="certificatesContainer">
                <!-- Loading state -->
                <div class="col-12 text-center py-5" id="loadingState">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading certificates...</span>
                    </div>
                    <p class="mt-3">Loading your certificates...</p>
                </div>
            </div>

            <!-- Empty state -->
            <div class="row" id="emptyState" style="display: none;">
                <div class="col-12 text-center py-5">
                    <div class="text-muted mb-3">
                        <i class="fas fa-certificate fa-4x"></i>
                    </div>
                    <h4 class="text-muted mb-3">You don't have any certificates yet</h4>
                    <p class="text-muted mb-4">Complete courses to get your first certificates</p>
                    <a href="capacitaciones.html" class="btn btn-accent">
                        <i class="fas fa-graduation-cap me-2"></i>
                        Explore Courses
                    </a>
                </div>
            </div>
        </div>
    </main>

    <!-- Certificate Detail Modal -->
    <div class="modal fade" id="certificateModal" tabindex="-1" aria-labelledby="certificateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="certificateModalLabel">
                        <i class="fas fa-certificate me-2"></i>
                        Certificate Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="certificateModalBody">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="downloadCertificateBtn">
                        <i class="fas fa-download me-2"></i>
                        Download Certificate
                    </button>
                    <button type="button" class="btn btn-accent" id="shareCertificateBtn">
                        <i class="fas fa-share-alt me-2"></i>
                        Share
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer will be loaded dynamically -->

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="module">
        import { initNavigation } from '../js/navigation.js';
        import { showToast } from '../js/ui.js';
        import { getCurrentUser } from '../js/guards.js';
        
        // Sample certificates data
        const certificatesData = [
            {
                id: 1,
                title: "Advanced React",
                category: "frontend",
                issueDate: "2024-03-15",
                expiryDate: "2026-03-15",
                score: 95,
                hours: 20,
                instructor: "Carlos Mendoza",
                status: "completed",
                verificationCode: "CRT-2024-003-15",
                skills: ["React", "Redux", "TypeScript", "Testing"]
            },
            {
                id: 2,
                title: "Professional Node.js",
                category: "backend",
                issueDate: "2024-02-20",
                expiryDate: "2026-02-20",
                score: 88,
                hours: 30,
                instructor: "Ana Rodriguez",
                status: "completed",
                verificationCode: "CRT-2024-002-20",
                skills: ["Node.js", "Express", "MongoDB", "REST APIs"]
            },
            {
                id: 3,
                title: "Python for Data Science",
                category: "data-science",
                issueDate: "2024-01-10",
                expiryDate: "2025-12-15",
                score: 92,
                hours: 35,
                instructor: "Dr. Luis García",
                status: "expiring",
                verificationCode: "CRT-2024-001-10",
                skills: ["Python", "Pandas", "NumPy", "Machine Learning"]
            },
            {
                id: 4,
                title: "Agile Project Management",
                category: "management",
                issueDate: "2023-11-25",
                expiryDate: "2025-11-25",
                score: 89,
                hours: 25,
                instructor: "María Fernández",
                status: "completed",
                verificationCode: "CRT-2023-011-25",
                skills: ["Scrum", "Kanban", "Agile", "Leadership"]
            }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize navigation with current page
            initNavigation('certificates', true);
            
            // Check authentication
            const user = getCurrentUser();
            if (!user) {
                window.location.href = '../index.html';
                return;
            }
            
            // Load certificates after a short delay to show loading state
            setTimeout(() => {
                loadCertificates();
            }, 1000);
            
            // Initialize event listeners
            initializeEventListeners();
        });

        function loadCertificates() {
            const container = document.getElementById('certificatesContainer');
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            
            if (certificatesData.length === 0) {
                loadingState.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            // Hide loading state
            loadingState.style.display = 'none';
            
            // Generate certificate cards
            const certificatesHTML = certificatesData.map(cert => createCertificateCard(cert)).join('');
            container.innerHTML = certificatesHTML;
            
            // Update statistics
            updateStatistics();
        }

        function createCertificateCard(certificate) {
            const statusBadge = getStatusBadge(certificate.status);
            const categoryBadge = getCategoryBadge(certificate.category);
            const isExpiring = certificate.status === 'expiring';
            
            return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 certificate-card ${isExpiring ? 'border-warning' : ''}" data-certificate-id="${certificate.id}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="flex-grow-1">
                                    ${categoryBadge}
                                    ${statusBadge}
                                </div>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item view-certificate" href="#" data-id="${certificate.id}">
                                            <i class="fas fa-eye me-2"></i>View Details
                                        </a></li>
                                        <li><a class="dropdown-item download-certificate" href="#" data-id="${certificate.id}">
                                            <i class="fas fa-download me-2"></i>Download PDF
                                        </a></li>
                                        <li><a class="dropdown-item share-certificate" href="#" data-id="${certificate.id}">
                                            <i class="fas fa-share-alt me-2"></i>Share
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item verify-certificate" href="#" data-id="${certificate.id}">
                                            <i class="fas fa-shield-check me-2"></i>Verify
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="text-center mb-3">
                                <div class="certificate-icon mb-3">
                                    <i class="fas fa-award fa-3x text-primary"></i>
                                </div>
                                <h5 class="card-title mb-2">${certificate.title}</h5>
                                <p class="text-muted small mb-2">Instructor: ${certificate.instructor}</p>
                            </div>
                            
                            <div class="certificate-details">
                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <div class="metric-small">
                                            <div class="h5 text-success mb-0">${certificate.score}</div>
                                            <small class="text-muted">Score</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="metric-small">
                                            <div class="h5 text-info mb-0">${certificate.hours}h</div>
                                            <small class="text-muted">Duration</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="metric-small">
                                            <div class="h5 text-warning mb-0">${certificate.skills.length}</div>
                                            <small class="text-muted">Skills</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted d-block">
                                        <i class="fas fa-calendar me-1"></i>
                                        Issued: ${formatDate(certificate.issueDate)}
                                    </small>
                                    <small class="text-muted d-block">
                                        <i class="fas fa-calendar-check me-1"></i>
                                        ${isExpiring ? 'Expires: ' : 'Valid until: '} ${formatDate(certificate.expiryDate)}
                                    </small>
                                    <small class="text-muted d-block">
                                        <i class="fas fa-qrcode me-1"></i>
                                        Code: ${certificate.verificationCode}
                                    </small>
                                </div>
                                
                                <div class="skills-preview mb-3">
                                    ${certificate.skills.slice(0, 3).map(skill => 
                                        `<span class="badge bg-light text-primary me-1 mb-1">${skill}</span>`
                                    ).join('')}
                                    ${certificate.skills.length > 3 ? 
                                        `<span class="badge bg-secondary">+${certificate.skills.length - 3}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary btn-sm flex-fill view-certificate" data-id="${certificate.id}">
                                    <i class="fas fa-eye me-1"></i>View
                                </button>
                                <button class="btn btn-accent btn-sm flex-fill download-certificate" data-id="${certificate.id}">
                                    <i class="fas fa-download me-1"></i>Download
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getStatusBadge(status) {
            const badges = {
                completed: '<span class="badge bg-success">Completed</span>',
                expiring: '<span class="badge bg-warning">Expiring Soon</span>',
                expired: '<span class="badge bg-danger">Expired</span>',
                pending: '<span class="badge bg-info">Pending</span>'
            };
            return badges[status] || badges.completed;
        }

        function getCategoryBadge(category) {
            const badges = {
                frontend: '<span class="badge bg-primary mb-2">Frontend</span>',
                backend: '<span class="badge bg-success mb-2">Backend</span>',
                'data-science': '<span class="badge bg-info mb-2">Data Science</span>',
                management: '<span class="badge bg-warning mb-2">Management</span>'
            };
            return badges[category] || '<span class="badge bg-secondary mb-2">Other</span>';
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function updateStatistics() {
            const total = certificatesData.length;
            const valid = certificatesData.filter(c => c.status === 'completed').length;
            const expiring = certificatesData.filter(c => c.status === 'expiring').length;
            const avgScore = Math.round(certificatesData.reduce((sum, c) => sum + c.score, 0) / total);
            
            document.getElementById('totalCertificates').textContent = total;
            document.getElementById('validCertificates').textContent = valid;
            document.getElementById('expiringCertificates').textContent = expiring;
            document.getElementById('achievementScore').textContent = avgScore;
        }

        function initializeEventListeners() {
            // Filter toggle
            document.getElementById('filterCertificatesBtn').addEventListener('click', () => {
                const filtersRow = document.getElementById('filtersRow');
                filtersRow.style.display = filtersRow.style.display === 'none' ? 'block' : 'none';
            });

            // View certificate details
            document.addEventListener('click', (e) => {
                if (e.target.closest('.view-certificate')) {
                    e.preventDefault();
                    const certificateId = e.target.closest('.view-certificate').dataset.id;
                    showCertificateDetails(certificateId);
                }
            });

            // Download certificate
            document.addEventListener('click', (e) => {
                if (e.target.closest('.download-certificate')) {
                    e.preventDefault();
                    const certificateId = e.target.closest('.download-certificate').dataset.id;
                    downloadCertificate(certificateId);
                }
            });

            // Share certificate
            document.addEventListener('click', (e) => {
                if (e.target.closest('.share-certificate')) {
                    e.preventDefault();
                    const certificateId = e.target.closest('.share-certificate').dataset.id;
                    shareCertificate(certificateId);
                }
            });

            // Download all certificates
            document.getElementById('downloadAllBtn').addEventListener('click', () => {
                downloadAllCertificates();
            });
        }

        function showCertificateDetails(certificateId) {
            const certificate = certificatesData.find(c => c.id == certificateId);
            if (!certificate) return;

            const modalBody = document.getElementById('certificateModalBody');
            modalBody.innerHTML = `
                <div class="certificate-preview text-center mb-4">
                    <div class="certificate-badge mb-3">
                        <i class="fas fa-award fa-4x text-primary"></i>
                    </div>
                    <h3 class="text-primary mb-2">${certificate.title}</h3>
                    <p class="text-muted">Certificate of Completion</p>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-group mb-3">
                            <label class="fw-semibold text-muted">Final Score:</label>
                            <div class="d-flex align-items-center">
                                <span class="h4 text-success me-2">${certificate.score}/100</span>
                                <div class="progress flex-grow-1" style="height: 8px;">
                                    <div class="progress-bar bg-success" style="width: ${certificate.score}%"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="info-group mb-3">
                            <label class="fw-semibold text-muted">Instructor:</label>
                            <p class="mb-0">${certificate.instructor}</p>
                        </div>
                        
                        <div class="info-group mb-3">
                            <label class="fw-semibold text-muted">Duration:</label>
                            <p class="mb-0">${certificate.hours} academic hours</p>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="info-group mb-3">
                            <label class="fw-semibold text-muted">Issue Date:</label>
                            <p class="mb-0">${formatDate(certificate.issueDate)}</p>
                        </div>
                        
                        <div class="info-group mb-3">
                            <label class="fw-semibold text-muted">Valid Until:</label>
                            <p class="mb-0">${formatDate(certificate.expiryDate)}</p>
                        </div>
                        
                        <div class="info-group mb-3">
                            <label class="fw-semibold text-muted">Verification Code:</label>
                            <p class="mb-0 font-monospace">${certificate.verificationCode}</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <label class="fw-semibold text-muted">Acquired Skills:</label>
                    <div class="skills-list mt-2">
                        ${certificate.skills.map(skill => 
                            `<span class="badge bg-primary me-1 mb-1">${skill}</span>`
                        ).join('')}
                    </div>
                </div>
            `;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('certificateModal'));
            modal.show();
            
            // Update modal button data
            document.getElementById('downloadCertificateBtn').dataset.certificateId = certificateId;
            document.getElementById('shareCertificateBtn').dataset.certificateId = certificateId;
        }

        function downloadCertificate(certificateId) {
            const certificate = certificatesData.find(c => c.id == certificateId);
            if (!certificate) return;
            
            showToast(`Downloading certificate: ${certificate.title}`, 'info');
            
            // Simulate download
            setTimeout(() => {
                showToast('Certificate downloaded successfully', 'success');
            }, 1500);
        }

        function shareCertificate(certificateId) {
            const certificate = certificatesData.find(c => c.id == certificateId);
            if (!certificate) return;
            
            const shareUrl = `${window.location.origin}/verify-certificate/${certificate.verificationCode}`;
            
            if (navigator.share) {
                navigator.share({
                    title: `Certificate: ${certificate.title}`,
                    text: `I have completed the course "${certificate.title}" at Catalyst HR System`,
                    url: shareUrl
                });
            } else {
                // Fallback - copy to clipboard
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showToast('Link copied to clipboard', 'success');
                });
            }
        }

        function downloadAllCertificates() {
            showToast('Preparing download of all certificates...', 'info');
            
            setTimeout(() => {
                showToast('All certificates downloaded in a ZIP file', 'success');
            }, 2000);
        }
    </script>
</body>
</html>